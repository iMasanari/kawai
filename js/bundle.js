!function(){function t(){n(+location.hash.slice(2)||0)}function e(){scrollTo(0,0),n(s()?0:r+1),history.pushState(null,"",r?"#/"+r:location.pathname)}function n(t){r=t,v.clear(),y.stop(),0===r?(o(0),i()):(o(1),v.createScene(pageDataList[r-1],function(){o(2),i()}))}function o(t){function e(t){t.style.display=null}function n(t){t.style.display="none"}switch(c=t){case 0:e(l),n(d);break;case 1:n(l),e(d),e(p),n(h);break;case 2:n(p),e(h),s()?(e(g),n(m)):(n(g),e(m))}}function i(){var t=pageDataList[r];if(t){var e=function(t){if(1!==c){var n=t.shift();void 0!==n&&y.load(n.sound,function(){e(t)})}};e(t.slice())}}function s(){return!pageDataList[r]}var r,c,a=function(){function t(){this.context=new(window.AudioContext||window.webkitAudioContext),this.bufferList={},this.playing=null,this.startTime=0}return t.prototype.load=function(t,e){var n=this;if(this.bufferList[t])return void(e&&setTimeout(e,1));var o=new XMLHttpRequest;o.open("GET",t),o.responseType="arraybuffer",o.onload=function(){return 200!=o.status?void(e&&e()):void n.context.decodeAudioData(o.response,function(o){n.bufferList[t]=o,e&&e()})},o.onerror=function(){e&&e()},o.send()},t.prototype.getControler=function(t){var e=this.bufferList[t];if(!e)return null;var n=this.context.createBufferSource(),o=this.context.createGain();return n.buffer=e,n.loop=!0,n.connect(o),o.connect(this.context.destination),{source:n,gain:o.gain}},t.prototype.start=function(t){var e=this;if(this.context.createBufferSource().start(),!t){var n=function(t){document.removeEventListener(t.type,n),e.start(!0)};document.addEventListener("touchstart",n)}},t.prototype.setStartTime=function(){this.startTime=this.context.currentTime},t.prototype.play=function(t){if(this.stop(),this.playing=this.getControler(t),this.playing){var e=(this.context.currentTime-this.startTime)%this.bufferList[t].duration;this.playing.source.start(0,e)}},t.prototype.stop=function(){this.playing&&this.playing.source.stop(),this.playing=null},t}(),u=function(){function t(t,e){var n=this;this.el=t,this.bgm=e,this.active=0,this.sceneHash=0,this.offsetList=[],this.scroll=function(){for(var t=document.documentElement.scrollTop||document.body.scrollTop,e=t+.8*window.innerHeight,o=n.offsetList.length;o--;){var i=n.offsetList[o],s=i.offset;if(s<e)return void(n.active!==o&&(n.active=o,i.play()))}},this.delayResize=function(){clearTimeout(n.resizeTimer),n.resizeTimer=setTimeout(function(){n.offsetList.forEach(function(t){return t.offset=t.img.offsetTop}),n.scroll()},200)},window.addEventListener("scroll",this.scroll,!1),window.addEventListener("resize",this.delayResize,!1)}return t.prototype.createScene=function(t,e){var n=this,o=this.sceneHash,i=function(t){n.bgm.setStartTime(),t.play(),0==(document.documentElement.scrollTop||document.body.scrollTop)&&window.scrollBy(0,.1)},s=t.length,r=function(c){n.createPage(t[c],function(t){o==n.sceneHash&&(0===c&&i(t),n.el.appendChild(t.el),t.offset=t.img.offsetTop,n.offsetList.push(t),c+1<s?r(c+1):e())})};r(0)},t.prototype.createPage=function(t,e){var n=this,o=new Image,i=document.createElement("li"),s=f(function(){e&&e({el:i,img:o,play:function(){n.bgm.play(t.sound)},offset:0})});this.bgm.load(t.sound,s.getCallback()),o.onload=o.onerror=s.getCallback(),o.src=t.image,i.className="page",i.appendChild(o)},t.prototype.clear=function(){this.sceneHash=Math.random(),this.offsetList.forEach(function(t){t.el.parentNode&&t.el.parentNode.removeChild(t.el)}),this.offsetList=[]},t}(),f=function(t){var e=0,n=function(){!--e&&t&&t()};return{getCallback:function(){return++e,n}}},l=document.getElementById("top"),d=document.getElementById("comic"),p=document.getElementById("loading"),h=document.getElementById("next"),m=document.getElementById("next-text"),g=document.getElementById("next-text-lastpage"),y=new a,v=new u(document.getElementById("pages"),y);l.addEventListener("click",e),h.addEventListener("click",e),window.addEventListener("popstate",t),y.start(),t()}();